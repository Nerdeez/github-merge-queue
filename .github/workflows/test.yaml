#
# The test will run after the build workflow completes
# it will check the build.result.txt file to determine if the build passed or failed.
# if the build passed, the test will run and create a check using the GitHub API.
# if the build failed, the test will not run and the workflow will fail.
#

name: Test

on:
  workflow_run:
    workflows: [Build]
    types: [completed]

jobs:
  test:
    runs-on: ubuntu-slim
    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.2

      - name: Check if running from merge queue
        id: is_merge_queue
        uses: actions/github-script@v8
        with:
          script: |
            let isQueue = false;
            if (github.event && github.event.workflow_run && github.event.workflow_run.head_branch) {
              const headBranch = github.event.workflow_run.head_branch;
              isQueue = headBranch.startsWith('gh-readonly-queue/');
              core.info(`Branch: ${headBranch}, Is merge queue: ${isQueue}`);
            }
            core.setOutput('is_merge_queue', isQueue);
            core.info(`Running from merge queue: ${isQueue}`);

      - name: Get PR number from workflow run
        id: get_pr
        if: steps.is_merge_queue.outputs.is_merge_queue != 'true'
        uses: actions/github-script@v8
        continue-on-error: true
        with:
          script: |
            if (!github.event || !github.event.workflow_run) {
              core.setOutput('pr_number', '');
              return;
            }
            
            const headBranch = github.event.workflow_run.head_branch;
            core.info(`Head branch: ${headBranch}`);
            core.debug(`Branch type: ${typeof headBranch}`);
            
            if (!headBranch) {
              core.info('No head branch found, skipping PR lookup');
              core.setOutput('pr_number', '');
              return;
            }
            
            core.info(`Looking up PR for branch: ${headBranch}`);
            
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${headBranch}`,
              state: 'open'
            });
            
            core.info(`Found ${prs.length} PR(s) for branch: ${headBranch}`);
            
            if (prs.length > 0) {
              core.info(`Using PR #${prs[0].number}`);
              core.setOutput('pr_number', prs[0].number);
            } else {
              core.info('No PR found, setting pr_number to empty');
              core.setOutput('pr_number', '');
            }

      - name: Create check run
        id: create_check
        if: steps.is_merge_queue.outputs.is_merge_queue != 'true'
        uses: actions/github-script@v8
        with:
          script: |
            // Debug: Log event structure
            core.debug(`Event type: ${github.event_name}`);
            core.debug(`Event keys: ${JSON.stringify(Object.keys(github.event || {}))}`);
            
            if (!github.event) {
              core.setFailed('github.event is undefined');
              return;
            }
            
            if (!github.event.workflow_run) {
              core.setFailed('workflow_run event data is missing. Event structure: ' + JSON.stringify(github.event, null, 2));
              return;
            }
            
            const headSha = github.event.workflow_run.head_sha;
            if (!headSha) {
              core.setFailed('head_sha is missing from workflow_run event');
              return;
            }
            
            const { data: checkRun } = await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Test',
              head_sha: headSha,
              status: 'in_progress',
              output: {
                title: 'Test is running',
                summary: 'Test workflow is executing'
              }
            });
            
            core.setOutput('check_run_id', checkRun.id);

      - name: Sleep for 3 minutes
        run: sleep 180

      - name: Check test result
        id: check_result
        run: |
          if [ -f test.result.txt ]; then
            RESULT=$(cat test.result.txt | tr -d '[:space:]')
            echo "result=$RESULT" >> $GITHUB_OUTPUT
          else
            echo "result=pass" >> $GITHUB_OUTPUT
          fi

      - name: Update check run with result
        if: steps.is_merge_queue.outputs.is_merge_queue != 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const result = '${{ steps.check_result.outputs.result }}';
            const conclusion = result === 'fail' ? 'failure' : 'success';
            const title = result === 'fail' ? 'Test failed' : 'Test passed';
            const summary = result === 'fail' 
              ? 'Test failed based on test.result.txt content'
              : 'Test passed successfully';
            
            await github.rest.checks.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              check_run_id: ${{ steps.create_check.outputs.check_run_id }},
              status: 'completed',
              conclusion: conclusion,
              output: {
                title: title,
                summary: summary
              }
            });

      - name: Pass or fail based on result
        run: |
          if [ "${{ steps.check_result.outputs.result }}" = "fail" ]; then
            echo "Test failed based on test.result.txt content"
            exit 1
          else
            echo "Test passed"
          fi